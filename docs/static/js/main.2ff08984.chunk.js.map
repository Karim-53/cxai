{"version":3,"sources":["database","App.js","index.js"],"names":["nodes","value","label","children","sql","disabled","console","log","window","location","href","includes","pecentage_per_category","map","category","join","App","useState","db","setDb","error","setError","useEffect","a","sqlPromise","initSqlJs","locateFile","sqlWasm","dataPromise","fetch","DB","then","res","arrayBuffer","catch","Promise","all","SQL","buf","Database","Uint8Array","toString","SQLRepl","arrayColumn","arr","n","x","average_score","dico","data","count","sum","i","length","average","Number","explainer","checked","r","df","selected_explainer","setExplainer","setChecked","expanded","setExpanded","exec","results","column","to_dict","columns","percentage","values","time_per_test","eligible_points","text","merged","push","pareto","pf","getParetoFrontier","optimize","y","mode","type","name","textposition","textfont","family","marker","size","className","layout","xaxis","autorange","title","yaxis","legend","yref","font","onClick","points","divId","onCheck","onExpand","showExpandAll","id","ResultsTable","columnName","row","rootElement","document","getElementById","ReactDOM","render","StrictMode"],"mappings":"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","file":"static/js/main.2ff08984.chunk.js","sourcesContent":["export default __webpack_public_path__ + \"static/media/database.33c07167.bin\";","// some sql.js op https://phiresky.github.io/blog/2021/hosting-sqlite-databases-on-github-pages/\nimport React, { useState, useEffect } from \"react\";\nimport \"./styles.css\";\nimport initSqlJs from \"sql.js\"; // https://sql.js.org/#%2F=     test env https://sql.js.org/examples/GUI/index.html\nimport pf from 'pareto-frontier';\nimport DB from './database';\nimport sqlWasm from \"!!file-loader?name=sql-wasm-[contenthash].wasm!sql.js/dist/sql-wasm.wasm\"; // Required to let webpack 4 know it needs to copy the wasm file to our assets\nimport Plot from 'react-plotly.js';\nimport CheckboxTree from 'react-checkbox-tree';\nimport \"react-checkbox-tree/lib/react-checkbox-tree.css\";\n// import DataTable from 'react-data-table-component'; todo [after acceptance] https://datatables.net/\nconst nodes = [\n{ // todo include all of them in one big node \"Filter:\"\n  value: 'supported_model_checklist',\n  label: 'I need to explain specific AI model(s):',\n  children: [\n      { value: 'supported_model_model_agnostic', label: 'Any (Model agnostic xAI alg.)', sql:'explainer.supported_model_model_agnostic = 1' },\n      { value: 'supported_model_tree_based', label: 'Tree-based' },\n      { value: 'supported_model_neural_network', label: 'Neural Network' },\n  ],\n},\n{\n  value: 'required_output_checklist',\n  label: 'I need specific output(s) from the XAI:',\n  children: [\n      { value: 'output_importance', label: 'Feature importance (Global Explanation)'},\n      { value: 'output_attribution', label: 'Feature attribution (Local Explanation)' }, //  # We discuss the attribution problem, i.e., the problem of distributing the prediction score of a model for a specific input to its base features (cf. [15, 10, 19]); the attribution to a base feature can be interpreted as the importance of the feature to the prediction. https://arxiv.org/pdf/1908.08474.pdf\n      { value: 'output_interaction', label: 'Pair feature interaction (Global Explanation)' },\n      // # Definition 1 (Statistical Non-Additive Interaction). A function f contains a statistical non-additive interaction of multiple features indexed in set I if and only if f cannot be decomposed into a sum of |I| subfunctions fi , each excluding the i-th interaction variable: f(x) =/= Sum i∈I fi(x\\{i}).\n      // #  Def. 1 identifies a non-additive effect among all features I on the output of function f (Friedman and Popescu, 2008; Sorokina et al., 2008; Tsang et al., 2018a). see https://arxiv.org/pdf/2103.03103.pdf\n      // # todo [after acceptance] we need a page with a clear description of each option\n      { value: 'todo1', label: '#Future work: Pair interaction (Local Ex), multi F interaction, NLP, debugging ...', disabled:true  }\n  ]\n},\n{\n  value: 'required_input_data_',\n  label: 'Select if we can not provide the following information to the xAI algorithm:',\n  children: [\n      { value: 'required_input_X_reference', label: 'A reference input data' },\n      { value: 'required_input_truth_to_explain', label: 'Target values of the data points to explain (truth, not prediction)' },\n  ]\n},\n{\n  value: 'explainer_input_xai_',\n  label: 'Select if we can not execute the following operations on the AI model:',\n  children: [\n      { value: 'required_input_predict_func', label: 'Perform addional predictions.' },\n      { value: 'required_input_train_function', label: '#Future work: Retrain the model.', disabled:true },\n  ]\n},\n{\n  value: 'test_adversarial_attacks',\n  label: 'I trust the xAI output (I created the data and the model myself)'\n},\n{\n  value: 'assumptions_data_distribution_iid',\n  label: '#Future work: Assume input features to be independent and identically distributed', disabled:true \n},\n{\n  value: 'explainer_need_gpu',\n  label: '#Future work: Constraint on hardware equipement: xAI alg. require a GPU.', disabled:true \n}\n// {\n//   value: 'uid',\n//   label: 'visible'\n// },\n];\nvar node_sql = {}\n// function flatten_nodes(nodes, node_sql){\n//   nodes.map( x => {if ('sql' in x) node_sql[x.value]= x.sql})\n//   nodes.map( x => {if ('children' in x) flatten_nodes(x.children)})\n// }\n// flatten_nodes(nodes) todo\nconsole.log('node_sql', node_sql)\n\nfunction average(data) {\n  /*Can't find an average function in JS, made one\n  This function is able to handle null values!!!*/\n    var count = null;\n    var sum = null;\n    for (let i=0; i<data.length; i++) {\n      if (data[i]) {\n        count++;\n        sum = sum + data[i];\n      }\n    }\n    if (count) {var average = Number( sum / count)} else { average=null}\n    return average;\n  }\nif (window.location.href.includes(\"localhost\")) { console.log('localhost');}\n\nconst categories = ['fidelity', 'fragility', 'stability', 'simplicity', 'stress']  // todo get it from db\nconst pecentage_per_category = categories.map(category => ' ROUND(AVG(case category when \\''+category+'\\' then score end)*100.0,1) AS percentage_'+category).join(',\\n ');\n\nexport default function App() {\n  const [db, setDb] = useState(null);\n  const [error, setError] = useState(null);\n\n  useEffect(async () => {\n    // sql.js needs to fetch its wasm file, so we cannot immediately instantiate the database\n    // without any configuration, initSqlJs will fetch the wasm files directly from the same path as the js\n    // see ../craco.config.js\n    try {\n      const sqlPromise = initSqlJs({ locateFile: () => sqlWasm });\n      const dataPromise = fetch(DB).then(res => res.arrayBuffer()).catch((error) => {\n        console.log('File not found:')\n        console.log(error)\n      });\n      const [SQL, buf] = await Promise.all([sqlPromise, dataPromise])\n      console.log('sql ok.')\n      setDb(new SQL.Database(new Uint8Array(buf)));\n    } catch (err) {\n      console.log('sql error:')\n      setError(err);\n    }\n  }, []);\n\n  if (error) return <pre>{error.toString()}</pre>;\n  else if (!db) return <pre>Loading...</pre>;\n  else return <SQLRepl db={db} />;\n}\n\nfunction to_dict(arr){\n  let dico = {}\n  for(let i = 0; i < arr.length; i++){\n      dico[arr[i]] = i;\n  }\n  return dico\n}\nconst arrayColumn = (arr, n) => arr.map(x => x[n]);\nconst average_score = (arr, dico) => arr.map(x => average([x[dico['percentage_fidelity']],x[dico['percentage_stability']]]));\n\nfunction sql(explainer, checked){\n\n  const r = `SELECT\texplainer,\nROUND(AVG(time),2) AS time_per_test,\ncount(score) AS eligible_points,\n` + pecentage_per_category + ` \nFROM cross_tab\nLeft JOIN test ON cross_tab.test = test.test\nGROUP BY explainer;\n\nSELECT\tcategory AS test_category, test.test, subtest, ROUND(score,2), ROUND(time),\ntest.description AS test_description\nFROM cross_tab\nLeft JOIN test ON cross_tab.test = test.test\nWhere (explainer = '`+explainer+`') and (score IS NOT NULL)\nOrder By test_category, test_subtest;\n`;\nconsole.log(r)\nreturn r\n}\n/**\n * A simple SQL read-eval-print-loop\n * @param {{db: import(\"sql.js\").Database}} props\n */\nfunction SQLRepl({ db }) {\n  const [selected_explainer, setExplainer] = useState('kernel_shap');\n  const [checked, setChecked] = useState(['output_importance']);\n  const [expanded, setExpanded] = useState([]);\n  const [results, setResults] = useState(db.exec(sql(selected_explainer, checked)));\n  const [error, setError] = useState(null);\n  \n  // console.log(sql(selected_explainer));\n  console.log('checked', checked);\n  function sql_exec(sql_bof) {\n    try {\n      // The sql is executed synchronously on the UI thread. You may want to use a web worker here instead\n      setResults(db.exec(sql(selected_explainer))); // an array of objects is returned\n      setError(null);\n    } catch (err) {\n      // exec throws an error when the SQL statement is invalid\n      setError(err);\n      setResults([]);\n    }\n  }\n  function plotly_click(data){\n    console.log('plotly_click:')\n    console.log(data)\n    console.log(data.points) \n  \n    let explainer = data.points[0].text\n  \n    setExplainer(explainer)\n  }\n  console.log('passed explainer', selected_explainer)\n  console.log(results)\n  var df;\n  df = results[0];\n  var column = to_dict(df.columns);\n\n  //const percentagefidelity = arrayColumn(df.values, column['percentagefidelity']);\n  const percentage = average_score(df.values, column)\n  // const percentage = arrayColumn(df.values, column['percentage']);\n  const time_per_test = arrayColumn(df.values, column['time_per_test']);\n  const eligible_points = arrayColumn(df.values, column['eligible_points']);\n  const text = arrayColumn(df.values, column['explainer']);\n  console.log(df)\n\n  var merged = []\n  for (let i = 0; i < time_per_test.length; i++) {\n    merged.push([percentage[i], time_per_test[i]]);\n  }\n  const pareto = pf.getParetoFrontier(merged, { optimize: 'bottomRight' });\n\n  const pareto_time_per_test = arrayColumn(pareto, 1);\n  const pareto_percentage = arrayColumn(pareto, 0);\n\n  // }\n\n\n  var trace1 = { // todo after acceptance Plotly.animate('graph', { https://plotly.com/javascript/plotlyjs-function-reference/#plotlyanimate\n    x: time_per_test,\n    y: percentage,\n    mode: 'markers+text',\n    type: 'scatter',\n    name: 'Explainers',\n    text: text, // hover https://plotly.com/javascript/reference/\n    textposition: 'top center',\n    textfont: {\n      family:  'Raleway, sans-serif'\n    },\n    marker: { size: eligible_points }\n  };\n\n  var trace2 = {\n    x: pareto_time_per_test,\n    y: pareto_percentage,\n    mode: 'lines',\n    type: 'scatter',\n    name: 'Pareto front',\n    // text: ['B-a', 'B-b', 'B-c', 'B-d', 'B-e'],\n    textfont : {\n      family:'Times New Roman'\n    },\n    textposition: 'bottom center',\n    // marker: { size: 6 }\n  };\n  var data = [ trace1, trace2 ];\n\n  var layout = {\n    xaxis: {\n      // range: [ 0.75, 5.25 ],\n      type: 'log',\n      autorange: true,\n      title: {\n        text: 'Average Time per test [Seconds] ↓'\n      }\n    },\n    yaxis: {\n      // range: [0, 100], todo\n      title: {\n        text: 'Score [%] ↑'\n      }\n    },\n    legend: {\n      y: 1,\n      yref: 'paper',\n      font: {\n        family: 'Arial, sans-serif',\n        // size: 20,\n        // color: 'grey',\n      }\n    },\n\n    title:\"Global overview of the explainers' performance\"\n  };  // todo [after acceptance] autosize: true, https://dev.to/dheerajmurali/building-a-responsive-chart-in-react-with-plotly-js-4on8\n\n  // Plotly.newPlot('myDiv', data, layout);\n\n\n\n\n  return (\n    <div className=\"App\">\n      <Plot\n        data={data}\n        layout={layout}\n        onClick={plotly_click}\n        divId={'fig'}\n      />\n      <h1>Filters</h1> \n      <pre>\n        <CheckboxTree\n            nodes={nodes}\n            checked={checked}\n            expanded={expanded}\n            onCheck={checked => {setChecked(checked)}}\n            onExpand={expanded => setExpanded(expanded)}\n            showExpandAll={true}\n        />\n      </pre>\n      {/* Kept XAI 11 / 11  Kept tests 18 / 18 */}\n      {/* on hover help https://reactjs.org/docs/events.html */}\n\n      <h1 id='explainer_title' >Click on an explainer for more details</h1>\n\n      {/* <textarea\n        onChange={(e) => sql_exec(e.target.value)}\n        placeholder=\"Enter some SQL. No inspiration ? Try “select sqlite_version()”\"\n      ></textarea> */}\n\n      <pre className=\"error\">{(error || \"\").toString()}</pre>\n\n      <pre>\n        {\n          // results contains one object per select statement in the query\n          results.map(({ columns, values }, i) => (\n            <ResultsTable key={i} columns={columns} values={values} />\n          ))\n        }\n      </pre>\n\n    </div>\n  );\n}\n\n/**\n * Renders a single value of the array returned by db.exec(...) as a table\n * @param {import(\"sql.js\").QueryExecResult} props\n */\nfunction ResultsTable({ columns, values }) {\n  return (\n    <table>\n      <thead>\n        <tr>\n          {columns.map((columnName, i) => (\n            <td key={i}>{columnName}</td>\n          ))}\n        </tr>\n      </thead>\n\n      <tbody>\n        {\n          // values is an array of arrays representing the results of the query\n          values.map((row, i) => (\n            <tr key={i}>\n              {row.map((value, i) => (\n                <td key={i}>{value}</td>\n              ))}\n            </tr>\n          ))\n        }\n      </tbody>\n    </table>\n  );\n}\n","import React from \"react\";\nimport ReactDOM from \"react-dom\";\n\nimport App from \"./App\";\n\nconst rootElement = document.getElementById(\"root\");\nReactDOM.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n  rootElement\n);\n"],"sourceRoot":""}